<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div id="app">
    <div id="content">
        <!-- Tab 1 Content (Spendings) -->
        <div class="tab-content active" data-tab="0">
            <div id="header">
                <div id="header-top">
                    <span id="net-total-label">Net total</span>
                    <div id="period-dropdown-container">
                        <span id="month-pill" class="clickable-pill">this month</span>
                        <div id="period-dropdown" class="period-dropdown" style="display: none;">
                            <div class="period-option" data-period="today">Today</div>
                            <div class="period-option" data-period="week">This week</div>
                            <div class="period-option active" data-period="month">This month</div>
                            <div class="period-option" data-period="year">This year</div>
                        </div>
                    </div>
                </div>
                <div id="total">Loading...</div>
            </div>
            <div id="transactions"></div>
        </div>
        
        <!-- Edit Transaction Popup -->
        <div id="edit-transaction-overlay" class="edit-transaction-overlay" style="display: none;">
            <div id="edit-transaction-popup" class="edit-transaction-popup">
                <button id="close-edit-button" class="close-edit-button">√ó</button>
                <div id="edit-container">
                    <input type="number" id="edit-amount" class="edit-input amount-input" placeholder="Amount" step="0.01" />
                    <input type="text" id="edit-name" class="edit-input name-input" placeholder="Transaction name" />
                    <div id="edit-buttons">
                        <button id="save-button" class="edit-button save-button">Save</button>
                        <button id="delete-button" class="edit-button delete-button">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab 2 Content (Categorize) -->
        <div class="tab-content" data-tab="1">
            <div id="categorize-container">
                <div id="categorize-transaction" class="categorize-transaction"></div>
                <div id="categorize-categories">
                    <div id="categorize-label" style="display: none;">Select Category</div>
                    <div id="categorize-buttons" class="categorize-buttons"></div>
                </div>
                <div id="categorize-complete" class="categorize-complete" style="display: none;">
                    <h2>We're all set</h2>
                </div>
            </div>
        </div>
        
        <!-- Tab 3 Content (Insights) -->
        <div class="tab-content" data-tab="2">
            <div class="tab-placeholder">
                <h2>Insights</h2>
                <p>Content coming soon...</p>
            </div>
        </div>
        
        <!-- Tab 4 Content (Settings) -->
        <div class="tab-content" data-tab="3">
            <div class="settings-container">
                <h2 class="settings-header">Settings</h2>
                <div class="settings-section">
                    <div class="settings-subheader">General</div>
                    <div class="settings-divider"></div>
                    <div class="settings-row currency-row" data-action="currency">
                        <div class="currency-icon-wrapper">
                            <svg class="currency-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <g clip-path="url(#clip_currency)">
                                    <path d="M12.3716 18.6793C14.8317 18.6793 16.9965 17.5641 17.8166 15.3172C17.8985 15.0958 17.9477 14.7678 17.9477 14.5627C17.9477 14.0954 17.6607 13.833 17.1933 13.833C16.7505 13.833 16.5291 14.0954 16.3897 14.4889C15.8977 16.2192 14.2494 17.195 12.3798 17.195C9.22269 17.195 7.72205 14.5381 7.72205 11.3155C7.72205 8.09278 9.27189 5.4851 12.3716 5.4851C14.1592 5.4851 15.7829 6.51013 16.2831 8.23219C16.4307 8.6586 16.6357 8.8964 17.0949 8.8964C17.5377 8.8964 17.8412 8.60939 17.8412 8.15838C17.8412 7.95337 17.792 7.64997 17.7017 7.41216C16.9063 5.2473 14.7415 4.00086 12.3716 4.00086C8.27147 4.00086 6 7.14155 6 11.3155C6 15.5304 8.24687 18.6793 12.3716 18.6793ZM8.36167 20.9835C8.67328 20.9835 8.86188 20.8441 8.92749 20.5408L13.4458 2.83642C13.4786 2.72162 13.495 2.63962 13.495 2.54942C13.495 2.22141 13.2982 2 12.9292 2C12.6586 2 12.47 2.164 12.3962 2.44281L7.87786 20.1553C7.84506 20.2701 7.82865 20.3768 7.82865 20.4833C7.82865 20.7376 8.03366 20.9835 8.36167 20.9835ZM11.5844 20.9835C11.896 20.9835 12.0846 20.8441 12.1584 20.5408L16.6767 2.83642C16.7013 2.72162 16.7259 2.63962 16.7259 2.54942C16.7259 2.22141 16.5291 2 16.1601 2C15.8895 2 15.6927 2.164 15.6189 2.44281L11.1006 20.1553C11.0759 20.2701 11.0595 20.3768 11.0595 20.4833C11.0595 20.7376 11.2564 20.9835 11.5844 20.9835Z" fill="currentColor"/>
                                </g>
                                <defs>
                                    <clipPath id="clip_currency">
                                        <rect width="12.2511" height="19" fill="white" transform="translate(6 2)"/>
                                    </clipPath>
                                </defs>
                            </svg>
                        </div>
                        <span class="settings-row-label">Currency</span>
                        <div class="settings-row-right">
                            <span class="settings-row-value">USD</span>
                            <svg class="chevron-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <g clip-path="url(#clip_chevron)">
                                    <path d="M17.6895 12.4766C17.6895 12.2324 17.5918 12.0078 17.4062 11.832L9.67188 4.25391C9.49609 4.08789 9.28125 4 9.02734 4C8.5293 4 8.13867 4.38086 8.13867 4.88867C8.13867 5.13281 8.23633 5.35742 8.39258 5.52344L15.502 12.4766L8.39258 19.4297C8.23633 19.5957 8.13867 19.8105 8.13867 20.0645C8.13867 20.5723 8.5293 20.9531 9.02734 20.9531C9.28125 20.9531 9.49609 20.8652 9.67188 20.6895L17.4062 13.1211C17.5918 12.9355 17.6895 12.7207 17.6895 12.4766Z" fill="currentColor"/>
                                </g>
                                <defs>
                                    <clipPath id="clip_chevron">
                                        <rect width="11.6895" height="16.9629" fill="white" transform="translate(6 4)"/>
                                    </clipPath>
                                </defs>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Currency Selection Page -->
        <div id="currency-selection-page" class="currency-selection-page" style="display: none;">
            <div class="currency-page-header">
                <button class="currency-back-button" id="currency-back-button">
                    <svg class="back-chevron-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.6895 12.4766C15.6895 12.2324 15.5918 12.0078 15.4062 11.832L7.67188 4.25391C7.49609 4.08789 7.28125 4 7.02734 4C6.5293 4 6.13867 4.38086 6.13867 4.88867C6.13867 5.13281 6.23633 5.35742 6.39258 5.52344L13.502 12.4766L6.39258 19.4297C6.23633 19.5957 6.13867 19.8105 6.13867 20.0645C6.13867 20.5723 6.5293 20.9531 7.02734 20.9531C7.28125 20.9531 7.49609 20.8652 7.67188 20.6895L15.4062 13.1211C15.5918 12.9355 15.6895 12.7207 15.6895 12.4766Z" fill="currentColor"/>
                    </svg>
                </button>
                <h2 class="currency-page-title">Currencies</h2>
            </div>
            <div class="currency-list" id="currency-list">
                <!-- Currency items will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Tab Bar -->
    <div id="tab-bar">
        <div class="tab-item active" data-tab="0">
            <span class="tab-icon">üìä</span>
            <span class="tab-label">Spendings</span>
        </div>
        <div class="tab-item" data-tab="1">
            <span class="tab-icon">üè∑Ô∏è</span>
            <span class="tab-label">Categorize</span>
        </div>
        <div class="tab-item" data-tab="2">
            <span class="tab-icon">üìà</span>
            <span class="tab-label">Insights</span>
        </div>
        <div class="tab-item" data-tab="3">
            <span class="tab-icon">‚öôÔ∏è</span>
            <span class="tab-label">Settings</span>
        </div>
    </div>
</div>

<script>
    const totalEl = document.getElementById('total');
    const listEl  = document.getElementById('transactions');

    // Store loadData function globally so it can be called when switching tabs
    let spendingsLoadData = null;
    let currentPeriod = 'month'; // Default period

    // Store functions for tab-specific actions
    let categorizeLoadFunctions = null;
    let loadCurrentCurrency = null;

    // Store Telegram WebApp instance for haptic feedback
    let tgWebApp = null;

    // Tab switching functionality
    function initTabs() {
        const tabItems = document.querySelectorAll('.tab-item');
        const tabContents = document.querySelectorAll('.tab-content');

        tabItems.forEach(item => {
            item.addEventListener('click', () => {
                const tabIndex = item.getAttribute('data-tab');
                
                // Haptic feedback when clicking tab
                if (tgWebApp && tgWebApp.HapticFeedback) {
                    try {
                        tgWebApp.HapticFeedback.impactOccurred('light');
                    } catch (e) {
                        // Fallback if HapticFeedback not available
                        if (tgWebApp.impactOccurred) {
                            tgWebApp.impactOccurred('light');
                        }
                    }
                }
                
                // Remove active class from all tabs and contents
                tabItems.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                item.classList.add('active');
                const activeContent = document.querySelector(`.tab-content[data-tab="${tabIndex}"]`);
                if (activeContent) {
                    activeContent.classList.add('active');
                }

                // Tab-specific data loading
                if (tabIndex === '0' && spendingsLoadData) {
                    // Reload Spendings data when switching to Spendings tab
                    spendingsLoadData();
                } else if (tabIndex === '1' && categorizeLoadFunctions) {
                    // Load categorize data when switching to Categorize tab
                    categorizeLoadFunctions();
                } else if (tabIndex === '3' && loadCurrentCurrency) {
                    // Load current currency when switching to Settings tab
                    loadCurrentCurrency();
                }
            });
        });
    }

    // Initialize tabs on load
    initTabs();

    function setError(msg) {
        totalEl.innerHTML = '<span class="currency-label">Error:</span> <span class="amount-value">' + msg + '</span>';
    }

    function formatDateHeader(date) {
        const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        const dayName = days[date.getDay()];
        const day = date.getDate();
        const month = months[date.getMonth()];
        return `${dayName}, ${day} ${month}`;
    }

    function formatTime(date) {
        let hours = date.getHours();
        const minutes = date.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        const minutesStr = minutes.toString().padStart(2, '0');
        return `${hours}:${minutesStr} ${ampm}`;
    }

    function formatAmount(amount) {
        const absAmount = Math.abs(amount);
        const parts = absAmount.toFixed(2).split('.');
        const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        return `${parts[1] ? integerPart + ',' + parts[1] : integerPart}`;
    }

    // Check if Telegram WebApp SDK is available
    if (typeof Telegram === 'undefined' || !Telegram.WebApp) {
        setError('Telegram Web App SDK not loaded');
        console.error('Telegram WebApp SDK is not available');
    } else {
        const tg = Telegram.WebApp;
        tg.ready();
        
        // Store Telegram WebApp instance for haptic feedback in tabs
        tgWebApp = tg;

        async function loadData() {
            try {
                if (!tg || !tg.initData) {
                    setError('Open inside Telegram');
                    console.warn('No initData ‚Äî likely opened outside Telegram WebApp.');
                    return;
                }

                console.log('‚û°Ô∏è Fetching /api/spendings/list with period:', currentPeriod);
                const res = await fetch('/api/spendings/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        initData: tg.initData,
                        period: currentPeriod
                    })
                });

                console.log('‚¨ÖÔ∏è Response status:', res.status);
                const data = await res.json();
                console.log('‚¨ÖÔ∏è Response body:', data);

                if (!data.ok) {
                    setError(data.error || 'Unknown API error');
                    return;
                }

                // Format total amount
                const total = Number(data.total);
                totalEl.innerHTML = `
                    <span class="currency-label">PLN</span>
                    <span class="amount-value">${formatAmount(total)}</span>
                `;

                // Group spendings by date
                const groupedByDate = {};
                for (const s of data.spendings) {
                    const date = new Date(s.created_at || s.date_of_log);
                    const dateKey = date.toDateString();
                    if (!groupedByDate[dateKey]) {
                        groupedByDate[dateKey] = [];
                    }
                    groupedByDate[dateKey].push(s);
                }

                // Sort dates descending
                const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
                    return new Date(b) - new Date(a);
                });

                listEl.innerHTML = '';
                
                if (sortedDates.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'empty-state';
                    const periodText = currentPeriod === 'today' ? 'today' : 
                                     currentPeriod === 'week' ? 'this week' :
                                     currentPeriod === 'month' ? 'this month' : 'this year';
                    empty.innerText = `No transactions ${periodText}.`;
                    listEl.appendChild(empty);
                } else {
                    for (const dateKey of sortedDates) {
                        const date = new Date(dateKey);
                        const transactions = groupedByDate[dateKey];
                        
                        // Calculate daily subtotal
                        const dailyTotal = transactions.reduce((sum, t) => sum + Number(t.amount || 0), 0);
                        
                        // Create date group container
                        const dateGroup = document.createElement('div');
                        dateGroup.className = 'date-group';
                        
                        // Date header
                        const dateHeader = document.createElement('div');
                        dateHeader.className = 'date-header';
                        dateHeader.innerHTML = `
                            <span class="date-label">${formatDateHeader(date)}</span>
                            <span class="daily-subtotal">${formatAmount(dailyTotal)} PLN</span>
                        `;
                        dateGroup.appendChild(dateHeader);
                        
                        // Date divider
                        const divider = document.createElement('div');
                        divider.className = 'date-divider';
                        dateGroup.appendChild(divider);
                        
                        // Transactions for this date
                        for (const s of transactions) {
                            const item = document.createElement('div');
                            item.className = 'transaction';
                            const transDate = new Date(s.created_at || s.date_of_log);
                            
                            // Get category info (handle both direct category object and nested categories object)
                            const category = s.categories || s.category || null;
                            const emoji = category?.emoji || '‚ùì';
                            const color = category?.color || '#9E9E9E';
                            
                            item.innerHTML = `
                                <div class="icon" style="background-color: ${color}">
                                    <span class="icon-emoji">${emoji}</span>
                                </div>
                                <div class="info">
                                    <div class="name">${s.name}</div>
                                    <div class="time">${formatTime(transDate)}</div>
                                </div>
                                <div class="amount">${formatAmount(Number(s.amount))} PLN</div>
                            `;
                            item.style.cursor = 'pointer';
                            item.setAttribute('data-spending-id', s.id);
                            item.addEventListener('click', () => openEditView(s));
                            dateGroup.appendChild(item);
                        }
                        
                        listEl.appendChild(dateGroup);
                    }
                }
            } catch (err) {
                console.error('loadData error', err);
                setError('Network or script error (see console)');
            }
        }

        loadData();
        
        // Store loadData function so it can be called when switching back to Spendings tab
        spendingsLoadData = loadData;

        // Edit Transaction functionality
        let currentEditingSpending = null;
        const editOverlay = document.getElementById('edit-transaction-overlay');
        const editAmountInput = document.getElementById('edit-amount');
        const editNameInput = document.getElementById('edit-name');
        const saveButton = document.getElementById('save-button');
        const deleteButton = document.getElementById('delete-button');
        const closeEditButton = document.getElementById('close-edit-button');

        function openEditView(spending) {
            currentEditingSpending = spending;
            editAmountInput.value = spending.amount;
            editNameInput.value = spending.name;
            
            // Show popup overlay
            editOverlay.style.display = 'flex';
            
            // Haptic feedback
            if (tgWebApp && tgWebApp.HapticFeedback) {
                try {
                    tgWebApp.HapticFeedback.impactOccurred('light');
                } catch (e) {
                    if (tgWebApp.impactOccurred) {
                        tgWebApp.impactOccurred('light');
                    }
                }
            }
        }

        function closeEditView() {
            currentEditingSpending = null;
            editOverlay.style.display = 'none';
        }

        // Close popup when clicking X button
        if (closeEditButton) {
            closeEditButton.addEventListener('click', closeEditView);
        }

        // Close popup when clicking on overlay background
        if (editOverlay) {
            editOverlay.addEventListener('click', (e) => {
                if (e.target === editOverlay) {
                    closeEditView();
                }
            });
        }

        async function saveTransaction() {
            if (!currentEditingSpending) return;

            const newAmount = parseFloat(editAmountInput.value);
            const newName = editNameInput.value.trim();

            if (isNaN(newAmount) || !newName) {
                alert('Please fill in both amount and name');
                return;
            }

            try {
                const res = await fetch('/api/spendings/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        spendingId: currentEditingSpending.id,
                        amount: newAmount,
                        name: newName
                    })
                });

                const data = await res.json();
                if (!data.ok) {
                    alert('Failed to update transaction: ' + (data.error || 'Unknown error'));
                    return;
                }

                // Haptic feedback
                if (tgWebApp && tgWebApp.HapticFeedback) {
                    try {
                        tgWebApp.HapticFeedback.notificationOccurred('success');
                    } catch (e) {
                        if (tgWebApp.notificationOccurred) {
                            tgWebApp.notificationOccurred('success');
                        }
                    }
                }

                closeEditView();
                loadData(); // Reload to show updated data
            } catch (err) {
                console.error('saveTransaction error', err);
                alert('Error saving transaction');
            }
        }

        async function deleteTransaction() {
            if (!currentEditingSpending) return;

            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }

            try {
                const res = await fetch('/api/spendings/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        spendingId: currentEditingSpending.id
                    })
                });

                const data = await res.json();
                if (!data.ok) {
                    alert('Failed to delete transaction: ' + (data.error || 'Unknown error'));
                    return;
                }

                // Haptic feedback
                if (tgWebApp && tgWebApp.HapticFeedback) {
                    try {
                        tgWebApp.HapticFeedback.notificationOccurred('success');
                    } catch (e) {
                        if (tgWebApp.notificationOccurred) {
                            tgWebApp.notificationOccurred('success');
                        }
                    }
                }

                closeEditView();
                loadData(); // Reload to show updated data
            } catch (err) {
                console.error('deleteTransaction error', err);
                alert('Error deleting transaction');
            }
        }

        if (saveButton) {
            saveButton.addEventListener('click', saveTransaction);
        }
        if (deleteButton) {
            deleteButton.addEventListener('click', deleteTransaction);
        }

        // Period dropdown functionality
        const monthPill = document.getElementById('month-pill');
        const periodDropdown = document.getElementById('period-dropdown');
        const periodOptions = document.querySelectorAll('.period-option');

        function updatePillText(period) {
            const textMap = {
                'today': 'today',
                'week': 'this week',
                'month': 'this month',
                'year': 'this year'
            };
            monthPill.innerText = textMap[period] || 'this month';
        }

        function updateActiveOption(period) {
            periodOptions.forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-period') === period) {
                    option.classList.add('active');
                }
            });
        }

        // Toggle dropdown when pill is clicked
        if (monthPill && periodDropdown) {
            monthPill.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = periodDropdown.style.display !== 'none';
                periodDropdown.style.display = isVisible ? 'none' : 'block';
            });

            // Handle period selection
            periodOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const selectedPeriod = option.getAttribute('data-period');
                    currentPeriod = selectedPeriod;
                    
                    updatePillText(selectedPeriod);
                    updateActiveOption(selectedPeriod);
                    periodDropdown.style.display = 'none';
                    
                    // Reload data with new period
                    loadData();
                    
                    // Haptic feedback
                    if (tgWebApp && tgWebApp.HapticFeedback) {
                        try {
                            tgWebApp.HapticFeedback.impactOccurred('light');
                        } catch (e) {
                            if (tgWebApp.impactOccurred) {
                                tgWebApp.impactOccurred('light');
                            }
                        }
                    }
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!monthPill.contains(e.target) && !periodDropdown.contains(e.target)) {
                    periodDropdown.style.display = 'none';
                }
            });
        }

        // Categorize functionality
        let uncategorizedSpendings = [];
        let categories = [];
        let currentSpendingIndex = 0;

        const categorizeContainer = document.getElementById('categorize-container');
        const categorizeTransaction = document.getElementById('categorize-transaction');
        const categorizeButtons = document.getElementById('categorize-buttons');
        const categorizeLabel = document.getElementById('categorize-label');
        const categorizeComplete = document.getElementById('categorize-complete');

        async function loadUncategorizedSpendings() {
            try {
                const res = await fetch('/api/spendings/uncategorized', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });

                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to load uncategorized spendings:', data.error);
                    return;
                }

                uncategorizedSpendings = data.spendings || [];
                currentSpendingIndex = 0;
                displayNextTransaction();
            } catch (err) {
                console.error('loadUncategorizedSpendings error', err);
            }
        }

        async function loadCategories() {
            try {
                const res = await fetch('/api/categories/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });

                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to load categories:', data.error);
                    return;
                }

                categories = data.categories || [];
                renderCategoryButtons();
            } catch (err) {
                console.error('loadCategories error', err);
            }
        }

        function renderCategoryButtons() {
            categorizeButtons.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-button';
                button.style.backgroundColor = category.color;
                button.innerHTML = `
                    <span class="category-emoji">${category.emoji}</span>
                    <span class="category-name">${category.name}</span>
                `;
                button.addEventListener('click', () => assignCategory(category.id));
                categorizeButtons.appendChild(button);
            });
        }

        function displayNextTransaction() {
            if (currentSpendingIndex >= uncategorizedSpendings.length) {
                // All transactions categorized
                categorizeTransaction.style.display = 'none';
                categorizeButtons.style.display = 'none';
                categorizeLabel.style.display = 'none';
                categorizeComplete.style.display = 'block';
                return;
            }

            const spending = uncategorizedSpendings[currentSpendingIndex];
            const transDate = new Date(spending.created_at || spending.date_of_log);
            
            categorizeTransaction.innerHTML = `
                <div class="categorize-transaction-item">
                    <div class="icon" style="background-color: #9E9E9E">
                        <span class="icon-emoji">‚ùì</span>
                    </div>
                    <div class="info">
                        <div class="name">${spending.name}</div>
                        <div class="time">${formatTime(transDate)}</div>
                    </div>
                    <div class="amount">${formatAmount(Number(spending.amount))} PLN</div>
                </div>
            `;

            categorizeTransaction.style.display = 'block';
            categorizeButtons.style.display = 'flex';
            categorizeLabel.style.display = 'block';
            categorizeComplete.style.display = 'none';
        }

        async function assignCategory(categoryId) {
            const spending = uncategorizedSpendings[currentSpendingIndex];
            
            try {
                const res = await fetch('/api/spendings/update-category', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        spendingId: spending.id,
                        categoryId: categoryId
                    })
                });

                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to update category:', data.error);
                    return;
                }

                // Move to next transaction
                currentSpendingIndex++;
                displayNextTransaction();
            } catch (err) {
                console.error('assignCategory error', err);
            }
        }

        // Store categorize load functions so they can be called when switching tabs
        categorizeLoadFunctions = () => {
            loadUncategorizedSpendings();
            loadCategories();
        };

        // Load categorize data on initial page load if categorize tab is active (unlikely but safe)
        const categorizeTabContent = document.querySelector('.tab-content[data-tab="1"]');
        if (categorizeTabContent && categorizeTabContent.classList.contains('active')) {
            categorizeLoadFunctions();
        }

        // Currency Selection functionality
        const currencyRow = document.querySelector('.currency-row');
        const currencySelectionPage = document.getElementById('currency-selection-page');
        const currencyBackButton = document.getElementById('currency-back-button');
        const currencyList = document.getElementById('currency-list');
        const settingsContent = document.querySelector('.settings-container');
        const currencyValueSpan = document.querySelector('.settings-row-value');
        let currencies = [];
        let currentCurrencyId = null;

        loadCurrentCurrency = async function() {
            try {
                const res = await fetch('/api/currencies/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });

                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to load current currency:', data.error);
                    return;
                }

                currentCurrencyId = data.currentCurrencyId;
                if (currentCurrencyId && currencyValueSpan) {
                    const currentCurrency = data.currencies?.find(c => c.id === currentCurrencyId);
                    if (currentCurrency) {
                        currencyValueSpan.textContent = currentCurrency.code;
                    }
                }
            } catch (err) {
                console.error('loadCurrentCurrency error', err);
            }
        };

        async function loadCurrencies() {
            try {
                const res = await fetch('/api/currencies/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });

                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to load currencies:', data.error);
                    return;
                }

                currencies = data.currencies || [];
                currentCurrencyId = data.currentCurrencyId;
                renderCurrencyList();
            } catch (err) {
                console.error('loadCurrencies error', err);
            }
        }

        function renderCurrencyList() {
            currencyList.innerHTML = '';
            currencies.forEach(currency => {
                const isSelected = currency.id === currentCurrencyId;
                const item = document.createElement('div');
                item.className = 'currency-item';
                item.setAttribute('data-currency-id', currency.id);
                
                item.innerHTML = `
                    <div class="currency-item-content">
                        <div class="currency-item-left">
                            <span class="currency-code">${currency.code}</span>
                            <span class="currency-name">${currency.name}</span>
                        </div>
                        ${isSelected ? `
                            <svg class="checkmark-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z" fill="currentColor"/>
                            </svg>
                        ` : ''}
                    </div>
                `;
                
                item.addEventListener('click', () => selectCurrency(currency.id));
                currencyList.appendChild(item);
            });
        }

        function openCurrencyPage() {
            settingsContent.style.display = 'none';
            currencySelectionPage.style.display = 'block';
            loadCurrencies();
            
            // Haptic feedback
            if (tgWebApp && tgWebApp.HapticFeedback) {
                try {
                    tgWebApp.HapticFeedback.impactOccurred('light');
                } catch (e) {
                    if (tgWebApp.impactOccurred) {
                        tgWebApp.impactOccurred('light');
                    }
                }
            }
        }

        function closeCurrencyPage() {
            currencySelectionPage.style.display = 'none';
            settingsContent.style.display = 'block';
            
            // Haptic feedback
            if (tgWebApp && tgWebApp.HapticFeedback) {
                try {
                    tgWebApp.HapticFeedback.impactOccurred('light');
                } catch (e) {
                    if (tgWebApp.impactOccurred) {
                        tgWebApp.impactOccurred('light');
                    }
                }
            }
        }

        async function selectCurrency(currencyId) {
            try {
                const res = await fetch('/api/user/update-currency', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        currencyId: currencyId
                    })
                });

                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to update currency:', data.error);
                    alert('Failed to update currency: ' + (data.error || 'Unknown error'));
                    return;
                }

                // Update current currency
                currentCurrencyId = currencyId;
                const selectedCurrency = currencies.find(c => c.id === currencyId);
                
                // Update the currency value in settings
                if (currencyValueSpan && selectedCurrency) {
                    currencyValueSpan.textContent = selectedCurrency.code;
                }

                // Update currency list
                renderCurrencyList();

                // Haptic feedback
                if (tgWebApp && tgWebApp.HapticFeedback) {
                    try {
                        tgWebApp.HapticFeedback.notificationOccurred('success');
                    } catch (e) {
                        if (tgWebApp.notificationOccurred) {
                            tgWebApp.notificationOccurred('success');
                        }
                    }
                }

                // Close the currency page after a short delay
                setTimeout(() => {
                    closeCurrencyPage();
                }, 300);
            } catch (err) {
                console.error('selectCurrency error', err);
                alert('Error updating currency');
            }
        }

        if (currencyRow) {
            currencyRow.addEventListener('click', openCurrencyPage);
        }

        if (currencyBackButton) {
            currencyBackButton.addEventListener('click', closeCurrencyPage);
        }
    }
</script>


<style>
    * {
        box-sizing: border-box;
    }

    body {
        font-family: 'Nunito', sans-serif;
        background: #ffffff;
        color: #000000;
        margin: 0;
        padding: 0;
        padding-bottom: 80px; /* Space for tab bar */
    }

    #app {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        max-width: 600px;
        margin: 0 auto;
        position: relative;
    }

    #content {
        flex: 1;
        padding: 20px;
        padding-bottom: 100px;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .tab-placeholder {
        text-align: center;
        padding: 60px 20px;
        color: #999999;
    }

    .tab-placeholder h2 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #000000;
    }

    .tab-placeholder p {
        font-size: 16px;
    }

    #header {
        margin-bottom: 32px;
        text-align: center;
        padding-top: 8vh;
        padding-bottom: 8vh;
    }

    #header-top {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    #net-total-label {
        font-size: 16px;
        font-weight: 500;
        color: #000000;
    }

    #period-dropdown-container {
        position: relative;
    }

    #month-pill.clickable-pill {
        font-size: 14px;
        font-weight: 400;
        color: #000000;
        background: #f5f5f5;
        border: 1px solid #e0e0e0;
        padding: 4px 10px;
        border-radius: 12px;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
    }

    #month-pill.clickable-pill:active {
        background-color: #e8e8e8;
    }

    .period-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 140px;
        z-index: 100;
        overflow: hidden;
    }

    .period-option {
        padding: 12px 16px;
        font-size: 14px;
        color: #000000;
        cursor: pointer;
        transition: background-color 0.2s;
        user-select: none;
    }

    .period-option:hover {
        background-color: #f5f5f5;
    }

    .period-option.active {
        background-color: #e8e8e8;
        font-weight: 600;
    }

    .period-option:not(:last-child) {
        border-bottom: 1px solid #f0f0f0;
    }

    #total {
        font-size: 42px;
        font-weight: 700;
        line-height: 1.2;
        text-align: center;
    }

    #total .currency-label {
        color: #999999;
        font-weight: 500;
        font-size: 32px;
    }

    #total .amount-value {
        color: #000000;
        font-weight: 700;
    }

    .date-group {
        margin-bottom: 32px;
    }

    .date-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .date-label {
        font-size: 14px;
        color: #999999;
        font-weight: 400;
    }

    .daily-subtotal {
        font-size: 14px;
        color: #999999;
        font-weight: 400;
    }

    .date-divider {
        height: 1px;
        background: #e0e0e0;
        margin-bottom: 12px;
    }

    .transaction {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }

    .icon {
        width: 56px;
        height: 56px;
        background: purple;
        border-radius: 8px;
        margin-right: 12px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .icon-emoji {
        font-size: 28px;
        line-height: 1;
    }

    .info {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .name {
        font-size: 18px;
        font-weight: 600;
        color: #000000;
        margin-bottom: 2px;
    }

    .time {
        font-size: 14px;
        color: #999999;
        font-weight: 400;
    }

    .amount {
        font-weight: 600;
        font-size: 18px;
        color: #000000;
        white-space: nowrap;
        margin-left: 12px;
    }

    .empty-state {
        text-align: center;
        color: #999999;
        font-size: 14px;
        padding: 40px 20px;
    }

    #tab-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #ffffff;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 8px 0;
        padding-bottom: max(20px, calc(env(safe-area-inset-bottom) + 12px));
        z-index: 1000;
        max-width: 600px;
        margin: 0 auto;
    }

    .tab-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        padding: 8px 4px;
        cursor: pointer;
        transition: opacity 0.2s;
        opacity: 0.5;
    }

    .tab-item.active {
        opacity: 1;
    }

    .tab-icon {
        font-size: 24px;
        margin-bottom: 4px;
    }

    .tab-label {
        font-size: 11px;
        font-weight: 400;
        color: #000000;
    }

    /* Categorize Tab Styles */
    #categorize-container {
        padding: 20px;
        display: flex;
        flex-direction: column;
        min-height: 60vh;
    }

    .categorize-transaction {
        margin-bottom: 40px;
    }

    .categorize-transaction-item {
        display: flex;
        align-items: center;
        background: var(--tg-theme-secondary-bg-color, #f5f5f5);
        padding: 16px;
        border-radius: 14px;
    }

    #categorize-categories {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    #categorize-label {
        font-size: 18px;
        font-weight: 600;
        color: #000000;
        margin-bottom: 16px;
        text-align: center;
    }

    .categorize-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
        align-items: flex-start;
    }

    .category-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 16px 20px;
        border-radius: 14px;
        border: none;
        cursor: pointer;
        min-width: 100px;
        transition: transform 0.1s, opacity 0.1s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .category-button:active {
        transform: scale(0.95);
        opacity: 0.8;
    }

    .category-emoji {
        font-size: 32px;
        margin-bottom: 8px;
    }

    .category-name {
        font-size: 14px;
        font-weight: 600;
        color: #000000;
        text-transform: capitalize;
    }

    .categorize-complete {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        text-align: center;
        padding: 60px 20px;
    }

    .categorize-complete h2 {
        font-size: 24px;
        font-weight: 600;
        color: #000000;
    }

    /* Edit Transaction Popup Styles */
    .edit-transaction-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 20px;
    }

    .edit-transaction-popup {
        background: #ffffff;
        border-radius: 20px;
        width: 100%;
        max-width: 400px;
        padding: 24px;
        position: relative;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .close-edit-button {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        font-size: 28px;
        color: #999999;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s, color 0.2s;
        line-height: 1;
        padding: 0;
    }

    .close-edit-button:hover {
        background-color: #f5f5f5;
        color: #000000;
    }

    .close-edit-button:active {
        background-color: #e8e8e8;
    }

    #edit-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 24px;
        padding-top: 8px;
    }

    .edit-input {
        width: 100%;
        padding: 16px;
        font-size: 18px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        background: #ffffff;
        color: #000000;
        text-align: center;
        font-family: 'Nunito', sans-serif;
    }

    .edit-input:focus {
        outline: none;
        border-color: #42A5F5;
    }

    .amount-input {
        font-size: 32px;
        font-weight: 600;
    }

    .name-input {
        font-size: 18px;
    }

    #edit-buttons {
        width: 100%;
        display: flex;
        gap: 12px;
        margin-top: 8px;
    }

    .edit-button {
        flex: 1;
        padding: 16px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.1s, opacity 0.1s;
        font-family: 'Nunito', sans-serif;
    }

    .edit-button:active {
        transform: scale(0.98);
        opacity: 0.9;
    }

    .save-button {
        background-color: #42A5F5;
        color: #ffffff;
    }

    .save-button:hover {
        background-color: #2196F3;
    }

    .delete-button {
        background-color: #E57373;
        color: #ffffff;
    }

    .delete-button:hover {
        background-color: #EF5350;
    }

    /* Settings Tab Styles */
    .settings-container {
        padding: 20px;
    }

    .settings-header {
        font-size: 32px;
        font-weight: 700;
        color: #000000;
        margin: 0;
        margin-bottom: 32px;
        text-align: left;
    }

    .settings-section {
        margin-bottom: 32px;
    }

    .settings-subheader {
        font-size: 14px;
        font-weight: 400;
        color: #A6A6A6;
        margin-bottom: 8px;
        text-align: left;
    }

    .settings-divider {
        height: 1px;
        background-color: #E0E0E0;
        margin-bottom: 16px;
    }

    .settings-row {
        display: flex;
        align-items: center;
        padding: 16px;
        background-color: #F5F5F5;
        border-radius: 12px;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        gap: 12px;
    }

    .settings-row:active {
        background-color: #E8E8E8;
        transform: scale(0.98);
    }

    .currency-icon-wrapper {
        width: 40px;
        height: 40px;
        background-color: #A5D6A7;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .currency-icon {
        width: 24px;
        height: 24px;
        color: #ffffff;
    }

    .settings-row-label {
        flex: 1;
        font-size: 16px;
        font-weight: 400;
        color: #000000;
        text-align: left;
    }

    .settings-row-right {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .settings-row-value {
        font-size: 14px;
        font-weight: 400;
        color: #A4A4A8;
    }

    .chevron-icon {
        width: 24px;
        height: 24px;
        color: #A4A4A8;
        flex-shrink: 0;
    }

    /* Currency Selection Page Styles */
    .currency-selection-page {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ffffff;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        max-width: 600px;
        margin: 0 auto;
        padding-bottom: 80px;
    }

    .currency-page-header {
        background-color: #F5F5F5;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
    }

    .currency-back-button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #E0E0E0;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        flex-shrink: 0;
        padding: 0;
    }

    .currency-back-button:active {
        background-color: #D0D0D0;
        transform: scale(0.95);
    }

    .back-chevron-icon {
        width: 24px;
        height: 24px;
        color: #000000;
    }

    .currency-page-title {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        font-size: 32px;
        font-weight: 700;
        color: #000000;
        margin: 0;
    }

    .currency-list {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .currency-item {
        padding: 16px 0;
        cursor: pointer;
        transition: background-color 0.2s;
        border-bottom: 1px solid #F0F0F0;
    }

    .currency-item:active {
        background-color: #F5F5F5;
    }

    .currency-item-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .currency-item-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .currency-code {
        font-size: 14px;
        font-weight: 400;
        color: #A4A4A8;
    }

    .currency-name {
        font-size: 16px;
        font-weight: 400;
        color: #000000;
    }

    .checkmark-icon {
        width: 24px;
        height: 24px;
        color: #000000;
        flex-shrink: 0;
    }
</style>
</body>
</html>
