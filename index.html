<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div id="app">
    <div id="content">
        <!-- Tab 1 Content (Spendings) -->
        <div class="tab-content active" data-tab="0">
            <div id="header">
                <div id="header-top">
                    <span id="net-total-label">Net total</span>
                    <div id="period-dropdown-container">
                        <span id="month-pill" class="clickable-pill">this month</span>
                        <div id="period-dropdown" class="period-dropdown" style="display: none;">
                            <div class="period-option" data-period="today">Today</div>
                            <div class="period-option" data-period="week">This week</div>
                            <div class="period-option active" data-period="month">This month</div>
                            <div class="period-option" data-period="year">This year</div>
                        </div>
                    </div>
                </div>
                <div id="total">
                    <div id="total-skeleton" class="skeleton-total">
                        <span class="skeleton-box skeleton-currency"></span>
                        <span class="skeleton-box skeleton-amount"></span>
                    </div>
                </div>
            </div>
            <div id="transactions">
                <div id="transactions-skeleton" class="skeleton-transactions">
                    <div class="skeleton-transaction-group">
                        <div class="skeleton-date-header">
                            <span class="skeleton-box skeleton-date-label"></span>
                            <span class="skeleton-box skeleton-date-subtotal"></span>
                        </div>
                        <div class="skeleton-date-divider"></div>
                        <div class="skeleton-transaction">
                            <div class="skeleton-icon"></div>
                            <div class="skeleton-info">
                                <div class="skeleton-box skeleton-name"></div>
                                <div class="skeleton-box skeleton-time"></div>
                            </div>
                            <div class="skeleton-box skeleton-amount-right"></div>
                        </div>
                        <div class="skeleton-transaction">
                            <div class="skeleton-icon"></div>
                            <div class="skeleton-info">
                                <div class="skeleton-box skeleton-name"></div>
                                <div class="skeleton-box skeleton-time"></div>
                            </div>
                            <div class="skeleton-box skeleton-amount-right"></div>
                        </div>
                        <div class="skeleton-transaction">
                            <div class="skeleton-icon"></div>
                            <div class="skeleton-info">
                                <div class="skeleton-box skeleton-name"></div>
                                <div class="skeleton-box skeleton-time"></div>
                            </div>
                            <div class="skeleton-box skeleton-amount-right"></div>
                        </div>
                    </div>
                    <div class="skeleton-transaction-group">
                        <div class="skeleton-date-header">
                            <span class="skeleton-box skeleton-date-label"></span>
                            <span class="skeleton-box skeleton-date-subtotal"></span>
                        </div>
                        <div class="skeleton-date-divider"></div>
                        <div class="skeleton-transaction">
                            <div class="skeleton-icon"></div>
                            <div class="skeleton-info">
                                <div class="skeleton-box skeleton-name"></div>
                                <div class="skeleton-box skeleton-time"></div>
                            </div>
                            <div class="skeleton-box skeleton-amount-right"></div>
                        </div>
                        <div class="skeleton-transaction">
                            <div class="skeleton-icon"></div>
                            <div class="skeleton-info">
                                <div class="skeleton-box skeleton-name"></div>
                                <div class="skeleton-box skeleton-time"></div>
                            </div>
                            <div class="skeleton-box skeleton-amount-right"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Edit Transaction Popup -->
        <div id="edit-transaction-overlay" class="edit-transaction-overlay" style="display: none;">
            <div id="edit-transaction-popup" class="edit-transaction-popup">
                <button id="close-edit-button" class="close-edit-button">×</button>
                <div id="edit-container">
                    <input type="number" id="edit-amount" class="edit-input amount-input" placeholder="Amount" step="0.01" />
                    <input type="text" id="edit-name" class="edit-input name-input" placeholder="Transaction name" />
                    <div id="edit-buttons">
                        <button id="save-button" class="edit-button save-button">Save</button>
                        <button id="delete-button" class="edit-button delete-button">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab 2 Content (Categorize) -->
        <div class="tab-content" data-tab="1">
            <div id="categorize-container">
                <h2 class="settings-header">Categorize</h2>
                <div id="categorize-transaction" class="categorize-transaction"></div>
                <div id="categorize-categories">
                    <div id="categorize-label" style="display: none;">Select Category</div>
                    <div id="categorize-buttons" class="categorize-buttons"></div>
                </div>
                <div id="categorize-complete" class="categorize-complete" style="display: none;">
                    <h2>We're all set</h2>
                </div>
            </div>
        </div>
        
        <!-- Tab 3 Content (Insights) -->
        <div class="tab-content" data-tab="2">
            <div class="insights-container">
                <h2 class="settings-header">Insights</h2>
                <div class="tab-placeholder">
                    <p>Content coming soon...</p>
                </div>
            </div>
        </div>
        
        <!-- Tab 4 Content (Settings) -->
        <div class="tab-content" data-tab="3">
            <div class="settings-container">
                <h2 class="settings-header">Settings</h2>
                <div class="settings-section">
                    <div class="settings-subheader">General</div>
                    <div class="settings-divider"></div>
                    <div class="settings-row currency-row" data-action="currency">
                        <div class="currency-icon-wrapper">
                            <svg class="currency-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <g clip-path="url(#clip_currency)">
                                    <path d="M12.3716 18.6793C14.8317 18.6793 16.9965 17.5641 17.8166 15.3172C17.8985 15.0958 17.9477 14.7678 17.9477 14.5627C17.9477 14.0954 17.6607 13.833 17.1933 13.833C16.7505 13.833 16.5291 14.0954 16.3897 14.4889C15.8977 16.2192 14.2494 17.195 12.3798 17.195C9.22269 17.195 7.72205 14.5381 7.72205 11.3155C7.72205 8.09278 9.27189 5.4851 12.3716 5.4851C14.1592 5.4851 15.7829 6.51013 16.2831 8.23219C16.4307 8.6586 16.6357 8.8964 17.0949 8.8964C17.5377 8.8964 17.8412 8.60939 17.8412 8.15838C17.8412 7.95337 17.792 7.64997 17.7017 7.41216C16.9063 5.2473 14.7415 4.00086 12.3716 4.00086C8.27147 4.00086 6 7.14155 6 11.3155C6 15.5304 8.24687 18.6793 12.3716 18.6793ZM8.36167 20.9835C8.67328 20.9835 8.86188 20.8441 8.92749 20.5408L13.4458 2.83642C13.4786 2.72162 13.495 2.63962 13.495 2.54942C13.495 2.22141 13.2982 2 12.9292 2C12.6586 2 12.47 2.164 12.3962 2.44281L7.87786 20.1553C7.84506 20.2701 7.82865 20.3768 7.82865 20.4833C7.82865 20.7376 8.03366 20.9835 8.36167 20.9835ZM11.5844 20.9835C11.896 20.9835 12.0846 20.8441 12.1584 20.5408L16.6767 2.83642C16.7013 2.72162 16.7259 2.63962 16.7259 2.54942C16.7259 2.22141 16.5291 2 16.1601 2C15.8895 2 15.6927 2.164 15.6189 2.44281L11.1006 20.1553C11.0759 20.2701 11.0595 20.3768 11.0595 20.4833C11.0595 20.7376 11.2564 20.9835 11.5844 20.9835Z" fill="currentColor"/>
                                </g>
                                <defs>
                                    <clipPath id="clip_currency">
                                        <rect width="12.2511" height="19" fill="white" transform="translate(6 2)"/>
                                    </clipPath>
                                </defs>
                            </svg>
                        </div>
                        <span class="settings-row-label">Currency</span>
                        <div class="settings-row-right">
                            <span class="settings-row-value">USD</span>
                            <svg class="chevron-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <g clip-path="url(#clip_chevron)">
                                    <path d="M17.6895 12.4766C17.6895 12.2324 17.5918 12.0078 17.4062 11.832L9.67188 4.25391C9.49609 4.08789 9.28125 4 9.02734 4C8.5293 4 8.13867 4.38086 8.13867 4.88867C8.13867 5.13281 8.23633 5.35742 8.39258 5.52344L15.502 12.4766L8.39258 19.4297C8.23633 19.5957 8.13867 19.8105 8.13867 20.0645C8.13867 20.5723 8.5293 20.9531 9.02734 20.9531C9.28125 20.9531 9.49609 20.8652 9.67188 20.6895L17.4062 13.1211C17.5918 12.9355 17.6895 12.7207 17.6895 12.4766Z" fill="currentColor"/>
                                </g>
                                <defs>
                                    <clipPath id="clip_chevron">
                                        <rect width="11.6895" height="16.9629" fill="white" transform="translate(6 4)"/>
                                    </clipPath>
                                </defs>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Currency Selection Page -->
        <div id="currency-selection-page" class="currency-selection-page" style="display: none;">
            <div class="currency-page-header">
                <button class="currency-back-button" id="currency-back-button">
                    <svg class="back-chevron-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_15_710)">
                            <path d="M6.3105 12.4766C6.3105 12.2324 6.4082 12.0078 6.5938 11.832L14.3281 4.25391C14.5039 4.08789 14.7187 4 14.9727 4C15.4707 4 15.8613 4.38086 15.8613 4.88867C15.8613 5.13281 15.7637 5.35742 15.6074 5.52344L8.49805 12.4766L15.6074 19.4297C15.7637 19.5957 15.8613 19.8105 15.8613 20.0645C15.8613 20.5723 15.4707 20.9531 14.9727 20.9531C14.7187 20.9531 14.5039 20.8652 14.3281 20.6895L6.5938 13.1211C6.4082 12.9355 6.3105 12.7207 6.3105 12.4766Z" fill="currentColor"/>
                        </g>
                        <defs>
                            <clipPath id="clip0_15_710">
                                <rect width="11.6895" height="16.9629" fill="white" transform="matrix(-1 0 0 1 18 4)"/>
                            </clipPath>
                        </defs>
                    </svg>
                </button>
                <h2 class="currency-page-title">Currencies</h2>
            </div>
            <div class="currency-list" id="currency-list">
                <!-- Currency items will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Tab Bar -->
    <div id="tab-bar">
        <div class="tab-item active" data-tab="0">
            <svg class="tab-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_12_323)">
                    <path d="M6 20C4.9 20 3.95833 19.6083 3.175 18.825C2.39167 18.0417 2 17.1 2 16V8C2 6.9 2.39167 5.95833 3.175 5.175C3.95833 4.39167 4.9 4 6 4H18C19.1 4 20.0417 4.39167 20.825 5.175C21.6083 5.95833 22 6.9 22 8V16C22 17.1 21.6083 18.0417 20.825 18.825C20.0417 19.6083 19.1 20 18 20H6ZM6 8H18C18.3667 8 18.7167 8.04167 19.05 8.125C19.3833 8.20833 19.7 8.34167 20 8.525V8C20 7.45 19.8042 6.97917 19.4125 6.5875C19.0208 6.19583 18.55 6 18 6H6C5.45 6 4.97917 6.19583 4.5875 6.5875C4.19583 6.97917 4 7.45 4 8V8.525C4.3 8.34167 4.61667 8.20833 4.95 8.125C5.28333 8.04167 5.63333 8 6 8ZM4.15 11.25L15.275 13.95C15.425 13.9833 15.575 13.9833 15.725 13.95C15.875 13.9167 16.0167 13.85 16.15 13.75L19.625 10.85C19.4417 10.6 19.2083 10.3958 18.925 10.2375C18.6417 10.0792 18.3333 10 18 10H6C5.56667 10 5.1875 10.1125 4.8625 10.3375C4.5375 10.5625 4.3 10.8667 4.15 11.25Z" fill="currentColor"/>
                </g>
                <defs>
                    <clipPath id="clip0_12_323">
                        <rect width="24" height="24" fill="white"/>
                    </clipPath>
                </defs>
            </svg>
        </div>
        <div class="tab-item" data-tab="1">
            <svg class="tab-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_12_328)">
                    <path d="M4 20C3.45 20 2.97917 19.8042 2.5875 19.4125C2.19583 19.0208 2 18.55 2 18V6C2 5.45 2.19583 4.97917 2.5875 4.5875C2.97917 4.19583 3.45 4 4 4H15C15.3167 4 15.6167 4.07083 15.9 4.2125C16.1833 4.35417 16.4167 4.55 16.6 4.8L21.1 10.8C21.3667 11.15 21.5 11.55 21.5 12C21.5 12.45 21.3667 12.85 21.1 13.2L16.6 19.2C16.4167 19.45 16.1833 19.6458 15.9 19.7875C15.6167 19.9292 15.3167 20 15 20H4Z" fill="currentColor"/>
                </g>
                <defs>
                    <clipPath id="clip0_12_328">
                        <rect width="24" height="24" fill="white"/>
                    </clipPath>
                </defs>
            </svg>
        </div>
        <div class="tab-item" data-tab="2">
            <svg class="tab-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_12_325)">
                    <path d="M8 12C7.71667 12 7.47917 12.0958 7.2875 12.2875C7.09583 12.4792 7 12.7167 7 13V16C7 16.2833 7.09583 16.5208 7.2875 16.7125C7.47917 16.9042 7.71667 17 8 17C8.28333 17 8.52083 16.9042 8.7125 16.7125C8.90417 16.5208 9 16.2833 9 16V13C9 12.7167 8.90417 12.4792 8.7125 12.2875C8.52083 12.0958 8.28333 12 8 12ZM16 7C15.7167 7 15.4792 7.09583 15.2875 7.2875C15.0958 7.47917 15 7.71667 15 8V16C15 16.2833 15.0958 16.5208 15.2875 16.7125C15.4792 16.9042 15.7167 17 16 17C16.2833 17 16.5208 16.9042 16.7125 16.7125C16.9042 16.5208 17 16.2833 17 16V8C17 7.71667 16.9042 7.47917 16.7125 7.2875C16.5208 7.09583 16.2833 7 16 7ZM12 14C11.7167 14 11.4792 14.0958 11.2875 14.2875C11.0958 14.4792 11 14.7167 11 15V16C11 16.2833 11.0958 16.5208 11.2875 16.7125C11.4792 16.9042 11.7167 17 12 17C12.2833 17 12.5208 16.9042 12.7125 16.7125C12.9042 16.5208 13 16.2833 13 16V15C13 14.7167 12.9042 14.4792 12.7125 14.2875C12.5208 14.0958 12.2833 14 12 14ZM5 21C4.45 21 3.97917 20.8042 3.5875 20.4125C3.19583 20.0208 3 19.55 3 19V5C3 4.45 3.19583 3.97917 3.5875 3.5875C3.97917 3.19583 4.45 3 5 3H19C19.55 3 20.0208 3.19583 20.4125 3.5875C20.8042 3.97917 21 4.45 21 5V19C21 19.55 20.8042 20.0208 20.4125 20.4125C20.0208 20.8042 19.55 21 19 21H5ZM12 12C12.2833 12 12.5208 11.9042 12.7125 11.7125C12.9042 11.5208 13 11.2833 13 11C13 10.7167 12.9042 10.4792 12.7125 10.2875C12.5208 10.0958 12.2833 10 12 10C11.7167 10 11.4792 10.0958 11.2875 10.2875C11.0958 10.4792 11 10.7167 11 11C11 11.2833 11.0958 11.5208 11.2875 11.7125C11.4792 11.9042 11.7167 12 12 12Z" fill="currentColor"/>
                </g>
                <defs>
                    <clipPath id="clip0_12_325">
                        <rect width="24" height="24" fill="white"/>
                    </clipPath>
                </defs>
            </svg>
        </div>
        <div class="tab-item" data-tab="3">
            <svg class="tab-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_12_331)">
                    <path d="M10.825 22C10.375 22 9.98751 21.85 9.66251 21.55C9.33751 21.25 9.14168 20.8833 9.07501 20.45L8.85001 18.8C8.63334 18.7167 8.42918 18.6167 8.23751 18.5C8.04584 18.3833 7.85834 18.2583 7.67501 18.125L6.12501 18.775C5.70834 18.9583 5.29168 18.975 4.87501 18.825C4.45834 18.675 4.13334 18.4083 3.90001 18.025L2.72501 15.975C2.49168 15.5917 2.42501 15.1833 2.52501 14.75C2.62501 14.3167 2.85001 13.9583 3.20001 13.675L4.52501 12.675C4.50834 12.5583 4.50001 12.4458 4.50001 12.3375V11.6625C4.50001 11.5542 4.50834 11.4417 4.52501 11.325L3.20001 10.325C2.85001 10.0417 2.62501 9.68333 2.52501 9.25C2.42501 8.81667 2.49168 8.40833 2.72501 8.025L3.90001 5.975C4.13334 5.59167 4.45834 5.325 4.87501 5.175C5.29168 5.025 5.70834 5.04167 6.12501 5.225L7.67501 5.875C7.85834 5.74167 8.05001 5.61667 8.25001 5.5C8.45001 5.38333 8.65001 5.28333 8.85001 5.2L9.07501 3.55C9.14168 3.11667 9.33751 2.75 9.66251 2.45C9.98751 2.15 10.375 2 10.825 2H13.175C13.625 2 14.0125 2.15 14.3375 2.45C14.6625 2.75 14.8583 3.11667 14.925 3.55L15.15 5.2C15.3667 5.28333 15.5708 5.38333 15.7625 5.5C15.9542 5.61667 16.1417 5.74167 16.325 5.875L17.875 5.225C18.2917 5.04167 18.7083 5.025 19.125 5.175C19.5417 5.325 19.8667 5.59167 20.1 5.975L21.275 8.025C21.5083 8.40833 21.575 8.81667 21.475 9.25C21.375 9.68333 21.15 10.0417 20.8 10.325L19.475 11.325C19.4917 11.4417 19.5 11.5542 19.5 11.6625V12.3375C19.5 12.4458 19.4833 12.5583 19.45 12.675L20.775 13.675C21.125 13.9583 21.35 14.3167 21.45 14.75C21.55 15.1833 21.4833 15.5917 21.25 15.975L20.05 18.025C19.8167 18.4083 19.4917 18.675 19.075 18.825C18.6583 18.975 18.2417 18.9583 17.825 18.775L16.325 18.125C16.1417 18.2583 15.95 18.3833 15.75 18.5C15.55 18.6167 15.35 18.7167 15.15 18.8L14.925 20.45C14.8583 20.8833 14.6625 21.25 14.3375 21.55C14.0125 21.85 13.625 22 13.175 22H10.825ZM12.05 15.5C13.0167 15.5 13.8417 15.1583 14.525 14.475C15.2083 13.7917 15.55 12.9667 15.55 12C15.55 11.0333 15.2083 10.2083 14.525 9.525C13.8417 8.84167 13.0167 8.5 12.05 8.5C11.0667 8.5 10.2375 8.84167 9.56251 9.525C8.88751 10.2083 8.55001 11.0333 8.55001 12C8.55001 12.9667 8.88751 13.7917 9.56251 14.475C10.2375 15.1583 11.0667 15.5 12.05 15.5Z" fill="currentColor"/>
                </g>
                <defs>
                    <clipPath id="clip0_12_331">
                        <rect width="24" height="24" fill="white"/>
                    </clipPath>
                </defs>
            </svg>
        </div>
    </div>
</div>

<script>
    const totalEl = document.getElementById('total');
    const listEl  = document.getElementById('transactions');

    // Store loadData function globally so it can be called when switching tabs
    let spendingsLoadData = null;
    let currentPeriod = 'month'; // Default period

    // Store functions for tab-specific actions
    let categorizeLoadFunctions = null;
    let loadCurrentCurrency = null;

    // Store Telegram WebApp instance for haptic feedback
    let tgWebApp = null;

    // Store current currency code globally
    let currentCurrencyCode = 'USD'; // Default to USD

    // Tab switching functionality
    function initTabs() {
        const tabItems = document.querySelectorAll('.tab-item');
        const tabContents = document.querySelectorAll('.tab-content');

        tabItems.forEach(item => {
            item.addEventListener('click', () => {
                const tabIndex = item.getAttribute('data-tab');
                
                // Haptic feedback when clicking tab
                if (tgWebApp && tgWebApp.HapticFeedback) {
                    try {
                        tgWebApp.HapticFeedback.impactOccurred('light');
                    } catch (e) {
                        // Fallback if HapticFeedback not available
                        if (tgWebApp.impactOccurred) {
                            tgWebApp.impactOccurred('light');
                        }
                    }
                }
                
                // Remove active class from all tabs and contents
                tabItems.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                item.classList.add('active');
                const activeContent = document.querySelector(`.tab-content[data-tab="${tabIndex}"]`);
                if (activeContent) {
                    activeContent.classList.add('active');
                }

                // Tab-specific data loading
                if (tabIndex === '0' && spendingsLoadData) {
                    // Reload Spendings data when switching to Spendings tab
                    // This ensures currency is up-to-date if it was changed in settings
                    spendingsLoadData();
                } else if (tabIndex === '1' && categorizeLoadFunctions) {
                    // Load categorize data when switching to Categorize tab
                    categorizeLoadFunctions();
                } else if (tabIndex === '3' && loadCurrentCurrency) {
                    // Load current currency when switching to Settings tab
                    loadCurrentCurrency().then(() => {
                        // Reload spendings data with updated currency if we're on spendings tab
                        // (in case user switches back to spendings tab after settings)
                        if (spendingsLoadData) {
                            spendingsLoadData();
                        }
                    });
                }
            });
        });
    }

    // Initialize tabs on load
    initTabs();

    function setError(msg) {
        totalEl.innerHTML = '<span class="currency-label">Error:</span> <span class="amount-value">' + msg + '</span>';
    }

    function formatDateHeader(date) {
        const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        const dayName = days[date.getDay()];
        const day = date.getDate();
        const month = months[date.getMonth()];
        return `${dayName}, ${day} ${month}`;
    }

    function formatTime(date) {
        let hours = date.getHours();
        const minutes = date.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        const minutesStr = minutes.toString().padStart(2, '0');
        return `${hours}:${minutesStr} ${ampm}`;
    }

    function formatAmount(amount) {
        const absAmount = Math.abs(amount);
        const parts = absAmount.toFixed(2).split('.');
        const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        return `${parts[1] ? integerPart + ',' + parts[1] : integerPart}`;
    }

    function truncateName(name) {
        if (!name) return '';
        if (name.length <= 12) return name;
        return name.substring(0, 12) + '...';
    }

    // Function to create total skeleton HTML
    function createTotalSkeleton() {
        return `
            <div id="total-skeleton" class="skeleton-total">
                <span class="skeleton-box skeleton-currency"></span>
                <span class="skeleton-box skeleton-amount"></span>
            </div>
        `;
    }

    // Function to create transactions skeleton HTML
    function createTransactionsSkeleton() {
        return `
            <div id="transactions-skeleton" class="skeleton-transactions">
                <div class="skeleton-transaction-group">
                    <div class="skeleton-date-header">
                        <span class="skeleton-box skeleton-date-label"></span>
                        <span class="skeleton-box skeleton-date-subtotal"></span>
                    </div>
                    <div class="skeleton-date-divider"></div>
                    <div class="skeleton-transaction">
                        <div class="skeleton-icon"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-box skeleton-name"></div>
                            <div class="skeleton-box skeleton-time"></div>
                        </div>
                        <div class="skeleton-box skeleton-amount-right"></div>
                    </div>
                    <div class="skeleton-transaction">
                        <div class="skeleton-icon"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-box skeleton-name"></div>
                            <div class="skeleton-box skeleton-time"></div>
                        </div>
                        <div class="skeleton-box skeleton-amount-right"></div>
                    </div>
                    <div class="skeleton-transaction">
                        <div class="skeleton-icon"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-box skeleton-name"></div>
                            <div class="skeleton-box skeleton-time"></div>
                        </div>
                        <div class="skeleton-box skeleton-amount-right"></div>
                    </div>
                </div>
                <div class="skeleton-transaction-group">
                    <div class="skeleton-date-header">
                        <span class="skeleton-box skeleton-date-label"></span>
                        <span class="skeleton-box skeleton-date-subtotal"></span>
                    </div>
                    <div class="skeleton-date-divider"></div>
                    <div class="skeleton-transaction">
                        <div class="skeleton-icon"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-box skeleton-name"></div>
                            <div class="skeleton-box skeleton-time"></div>
                        </div>
                        <div class="skeleton-box skeleton-amount-right"></div>
                    </div>
                    <div class="skeleton-transaction">
                        <div class="skeleton-icon"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-box skeleton-name"></div>
                            <div class="skeleton-box skeleton-time"></div>
                        </div>
                        <div class="skeleton-box skeleton-amount-right"></div>
                    </div>
                </div>
            </div>
        `;
    }

    // Function to show skeleton loaders
    function showSkeletons() {
        const totalSkeleton = document.getElementById('total-skeleton');
        const transactionsSkeleton = document.getElementById('transactions-skeleton');
        
        // Recreate skeletons if they don't exist (e.g., after tab switch)
        if (!totalSkeleton && totalEl) {
            totalEl.innerHTML = createTotalSkeleton();
        } else if (totalSkeleton) {
            totalSkeleton.style.display = 'block';
        }
        
        if (!transactionsSkeleton && listEl) {
            listEl.innerHTML = createTransactionsSkeleton();
        } else if (transactionsSkeleton) {
            transactionsSkeleton.style.display = 'block';
        }
    }

    // Function to hide skeleton loaders
    function hideSkeletons() {
        const totalSkeleton = document.getElementById('total-skeleton');
        const transactionsSkeleton = document.getElementById('transactions-skeleton');
        if (totalSkeleton) totalSkeleton.style.display = 'none';
        if (transactionsSkeleton) transactionsSkeleton.style.display = 'none';
    }

    // Show skeletons initially - wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', showSkeletons);
    } else {
        showSkeletons();
    }
    
    // Check if Telegram WebApp SDK is available
    if (typeof Telegram === 'undefined' || !Telegram.WebApp) {
        setError('Telegram Web App SDK not loaded');
        console.error('Telegram WebApp SDK is not available');
        hideSkeletons();
    } else {
        const tg = Telegram.WebApp;
        tg.ready();
        
        // Store Telegram WebApp instance for haptic feedback in tabs
        tgWebApp = tg;

        async function loadData(showLoadingState = true) {
            try {
                if (!tg || !tg.initData) {
                    setError('Open inside Telegram');
                    console.warn('No initData — likely opened outside Telegram WebApp.');
                    hideSkeletons();
                    return;
                }

                // Show skeletons when loading (unless already showing)
                if (showLoadingState) {
                    showSkeletons();
                }

                console.log('➡️ Fetching /api/spendings/list with period:', currentPeriod);
                const res = await fetch('/api/spendings/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        initData: tg.initData,
                        period: currentPeriod
                    })
                });

                console.log('⬅️ Response status:', res.status);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    let errorMsg = 'Network error';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMsg = errorData.error || errorMsg;
                    } catch (e) {
                        errorMsg = `HTTP ${res.status}: ${errorText || 'Unknown error'}`;
                    }
                    setError(errorMsg);
                    hideSkeletons();
                    return;
                }

                const data = await res.json();
                console.log('⬅️ Response body:', data);

                if (!data.ok) {
                    setError(data.error || 'Unknown API error');
                    hideSkeletons();
                    return;
                }

                // Format total amount
                const total = Number(data.total);
                totalEl.innerHTML = `
                    <span class="currency-label">${currentCurrencyCode}</span>
                    <span class="amount-value">${formatAmount(total)}</span>
                `;
                // Clear any existing animation classes and add hidden class initially, then animate
                totalEl.classList.remove('total-reveal');
                totalEl.classList.add('total-hidden');

                // Group spendings by date
                const groupedByDate = {};
                for (const s of data.spendings) {
                    const date = new Date(s.created_at || s.date_of_log);
                    const dateKey = date.toDateString();
                    if (!groupedByDate[dateKey]) {
                        groupedByDate[dateKey] = [];
                    }
                    groupedByDate[dateKey].push(s);
                }

                // Sort dates descending
                const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
                    return new Date(b) - new Date(a);
                });

                listEl.innerHTML = '';
                
                // Collect all transaction elements for stagger animation
                const allTransactionElements = [];
                
                if (sortedDates.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'empty-state';
                    const periodText = currentPeriod === 'today' ? 'today' : 
                                     currentPeriod === 'week' ? 'this week' :
                                     currentPeriod === 'month' ? 'this month' : 'this year';
                    empty.innerText = `No transactions ${periodText}.`;
                    listEl.appendChild(empty);
                    // Hide skeleton immediately for empty state
                    hideSkeletons();
                    // Animate total reveal for empty state
                    setTimeout(() => {
                        totalEl.classList.remove('total-hidden');
                        totalEl.classList.add('total-reveal');
                    }, 50);
                } else {
                    for (const dateKey of sortedDates) {
                        const date = new Date(dateKey);
                        const transactions = groupedByDate[dateKey];
                        
                        // Calculate daily subtotal
                        const dailyTotal = transactions.reduce((sum, t) => sum + Number(t.amount || 0), 0);
                        
                        // Create date group container
                        const dateGroup = document.createElement('div');
                        dateGroup.className = 'date-group';
                        
                        // Date header
                        const dateHeader = document.createElement('div');
                        dateHeader.className = 'date-header';
                        dateHeader.innerHTML = `
                            <span class="date-label">${formatDateHeader(date)}</span>
                            <span class="daily-subtotal">${formatAmount(dailyTotal)} ${currentCurrencyCode}</span>
                        `;
                        dateGroup.appendChild(dateHeader);
                        
                        // Date divider
                        const divider = document.createElement('div');
                        divider.className = 'date-divider';
                        dateGroup.appendChild(divider);
                        
                        // Transactions for this date
                        for (const s of transactions) {
                            const item = document.createElement('div');
                            item.className = 'transaction transaction-hidden';
                            const transDate = new Date(s.created_at || s.date_of_log);
                            
                            // Get category info (handle both direct category object and nested categories object)
                            const category = s.categories || s.category || null;
                            const emoji = category?.emoji || '❓';
                            const color = category?.color || '#9E9E9E';
                            
                            item.innerHTML = `
                                <div class="icon" style="background-color: ${color}">
                                    <span class="icon-emoji">${emoji}</span>
                                </div>
                                <div class="info">
                                    <div class="name">${s.name}</div>
                                    <div class="time">${formatTime(transDate)}</div>
                                </div>
                                <div class="amount">${formatAmount(Number(s.amount))} ${currentCurrencyCode}</div>
                            `;
                            item.style.cursor = 'pointer';
                            item.setAttribute('data-spending-id', s.id);
                            item.addEventListener('click', () => openEditView(s));
                            dateGroup.appendChild(item);
                            allTransactionElements.push(item);
                        }
                        
                        listEl.appendChild(dateGroup);
                    }
                    
                    // Hide skeleton and animate total first
                    hideSkeletons();
                    
                    // Animate total reveal (without haptic)
                    setTimeout(() => {
                        totalEl.classList.remove('total-hidden');
                        totalEl.classList.add('total-reveal');
                    }, 50);
                    
                    // Animate transactions one by one with stagger effect
                    allTransactionElements.forEach((transaction, index) => {
                        setTimeout(() => {
                            transaction.classList.remove('transaction-hidden');
                            transaction.classList.add('transaction-reveal');
                        }, index * 50); // 50ms delay between each transaction animation
                    });
                    
                    // Haptic feedback for first 3 transactions with more spacing (150ms between each)
                    if (tgWebApp && tgWebApp.HapticFeedback) {
                        const hapticTypes = ['heavy', 'medium', 'light'];
                        for (let i = 0; i < 3 && i < allTransactionElements.length; i++) {
                            setTimeout(() => {
                                try {
                                    tgWebApp.HapticFeedback.impactOccurred(hapticTypes[i]);
                                } catch (e) {
                                    // Fallback if HapticFeedback not available
                                    if (tgWebApp.impactOccurred) {
                                        tgWebApp.impactOccurred(hapticTypes[i]);
                                    }
                                }
                            }, i * 150); // 150ms delay between each haptic (more spaced out)
                        }
                    }
                }
            } catch (err) {
                console.error('loadData error', err);
                const errorMessage = err instanceof Error ? err.message : 'Network or script error';
                setError(errorMessage);
                hideSkeletons();
            }
        }

        // Store loadData function so it can be called when switching back to Spendings tab
        spendingsLoadData = loadData;
        
        // Don't load data here - wait for currency to be defined, then initialize

        // Edit Transaction functionality
        let currentEditingSpending = null;
        const editOverlay = document.getElementById('edit-transaction-overlay');
        const editAmountInput = document.getElementById('edit-amount');
        const editNameInput = document.getElementById('edit-name');
        const saveButton = document.getElementById('save-button');
        const deleteButton = document.getElementById('delete-button');
        const closeEditButton = document.getElementById('close-edit-button');

        function openEditView(spending) {
            currentEditingSpending = spending;
            editAmountInput.value = spending.amount;
            editNameInput.value = spending.name;
            
            // Show popup overlay
            editOverlay.style.display = 'flex';
            
            // Haptic feedback
            if (tgWebApp && tgWebApp.HapticFeedback) {
                try {
                    tgWebApp.HapticFeedback.impactOccurred('light');
                } catch (e) {
                    if (tgWebApp.impactOccurred) {
                        tgWebApp.impactOccurred('light');
                    }
                }
            }
        }

        function closeEditView() {
            currentEditingSpending = null;
            editOverlay.style.display = 'none';
        }

        // Close popup when clicking X button
        if (closeEditButton) {
            closeEditButton.addEventListener('click', closeEditView);
        }

        // Close popup when clicking on overlay background
        if (editOverlay) {
            editOverlay.addEventListener('click', (e) => {
                if (e.target === editOverlay) {
                    closeEditView();
                }
            });
        }

        async function saveTransaction() {
            if (!currentEditingSpending) return;

            const newAmount = parseFloat(editAmountInput.value);
            const newName = editNameInput.value.trim();

            if (isNaN(newAmount) || !newName) {
                alert('Please fill in both amount and name');
                return;
            }

            try {
                const res = await fetch('/api/spendings/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        spendingId: currentEditingSpending.id,
                        amount: newAmount,
                        name: newName
                    })
                });

                const data = await res.json();
                if (!data.ok) {
                    alert('Failed to update transaction: ' + (data.error || 'Unknown error'));
                    return;
                }

                // Haptic feedback
                if (tgWebApp && tgWebApp.HapticFeedback) {
                    try {
                        tgWebApp.HapticFeedback.notificationOccurred('success');
                    } catch (e) {
                        if (tgWebApp.notificationOccurred) {
                            tgWebApp.notificationOccurred('success');
                        }
                    }
                }

                closeEditView();
                loadData(); // Reload to show updated data
            } catch (err) {
                console.error('saveTransaction error', err);
                alert('Error saving transaction');
            }
        }

        async function deleteTransaction() {
            if (!currentEditingSpending) return;

            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }

            try {
                const res = await fetch('/api/spendings/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        spendingId: currentEditingSpending.id
                    })
                });

                const data = await res.json();
                if (!data.ok) {
                    alert('Failed to delete transaction: ' + (data.error || 'Unknown error'));
                    return;
                }

                // Haptic feedback
                if (tgWebApp && tgWebApp.HapticFeedback) {
                    try {
                        tgWebApp.HapticFeedback.notificationOccurred('success');
                    } catch (e) {
                        if (tgWebApp.notificationOccurred) {
                            tgWebApp.notificationOccurred('success');
                        }
                    }
                }

                closeEditView();
                loadData(); // Reload to show updated data
            } catch (err) {
                console.error('deleteTransaction error', err);
                alert('Error deleting transaction');
            }
        }

        if (saveButton) {
            saveButton.addEventListener('click', saveTransaction);
        }
        if (deleteButton) {
            deleteButton.addEventListener('click', deleteTransaction);
        }

        // Period dropdown functionality
        const monthPill = document.getElementById('month-pill');
        const periodDropdown = document.getElementById('period-dropdown');
        const periodOptions = document.querySelectorAll('.period-option');

        function updatePillText(period) {
            const textMap = {
                'today': 'today',
                'week': 'this week',
                'month': 'this month',
                'year': 'this year'
            };
            monthPill.innerText = textMap[period] || 'this month';
        }

        function updateActiveOption(period) {
            periodOptions.forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-period') === period) {
                    option.classList.add('active');
                }
            });
        }

        // Toggle dropdown when pill is clicked
        if (monthPill && periodDropdown) {
            monthPill.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = periodDropdown.style.display !== 'none';
                periodDropdown.style.display = isVisible ? 'none' : 'block';
            });

            // Handle period selection
            periodOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const selectedPeriod = option.getAttribute('data-period');
                    currentPeriod = selectedPeriod;
                    
                    updatePillText(selectedPeriod);
                    updateActiveOption(selectedPeriod);
                    periodDropdown.style.display = 'none';
                    
                    // Reload data with new period
                    loadData();
                    
                    // Haptic feedback
                    if (tgWebApp && tgWebApp.HapticFeedback) {
                        try {
                            tgWebApp.HapticFeedback.impactOccurred('light');
                        } catch (e) {
                            if (tgWebApp.impactOccurred) {
                                tgWebApp.impactOccurred('light');
                            }
                        }
                    }
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!monthPill.contains(e.target) && !periodDropdown.contains(e.target)) {
                    periodDropdown.style.display = 'none';
                }
            });
        }

        // Categorize functionality
        let uncategorizedSpendings = [];
        let categories = [];
        let currentSpendingIndex = 0;

        const categorizeContainer = document.getElementById('categorize-container');
        const categorizeTransaction = document.getElementById('categorize-transaction');
        const categorizeButtons = document.getElementById('categorize-buttons');
        const categorizeLabel = document.getElementById('categorize-label');
        const categorizeComplete = document.getElementById('categorize-complete');

        async function loadUncategorizedSpendings() {
            try {
                const res = await fetch('/api/spendings/uncategorized', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });

                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to load uncategorized spendings:', data.error);
                    return;
                }

                uncategorizedSpendings = data.spendings || [];
                currentSpendingIndex = 0;
                displayNextTransaction();
            } catch (err) {
                console.error('loadUncategorizedSpendings error', err);
            }
        }

        async function loadCategories() {
            try {
                const res = await fetch('/api/categories/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });

                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to load categories:', data.error);
                    return;
                }

                categories = data.categories || [];
                renderCategoryButtons();
            } catch (err) {
                console.error('loadCategories error', err);
            }
        }

        function renderCategoryButtons() {
            categorizeButtons.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-button';
                button.style.backgroundColor = category.color;
                button.innerHTML = `
                    <span class="category-emoji">${category.emoji}</span>
                    <span class="category-name">${category.name}</span>
                `;
                button.addEventListener('click', () => assignCategory(category.id));
                categorizeButtons.appendChild(button);
            });
        }

        function displayNextTransaction() {
            if (currentSpendingIndex >= uncategorizedSpendings.length) {
                // All transactions categorized
                categorizeTransaction.style.display = 'none';
                categorizeButtons.style.display = 'none';
                categorizeLabel.style.display = 'none';
                categorizeComplete.style.display = 'block';
                return;
            }

            const spending = uncategorizedSpendings[currentSpendingIndex];
            const transDate = new Date(spending.created_at || spending.date_of_log);
            
            categorizeTransaction.innerHTML = `
                <div class="categorize-transaction-item">
                    <div class="icon" style="background-color: #9E9E9E">
                        <span class="icon-emoji">❓</span>
                    </div>
                    <div class="info">
                        <div class="name">${spending.name}</div>
                        <div class="time">${formatTime(transDate)}</div>
                    </div>
                    <div class="amount">${formatAmount(Number(spending.amount))} ${currentCurrencyCode}</div>
                </div>
            `;

            categorizeTransaction.style.display = 'block';
            categorizeButtons.style.display = 'flex';
            categorizeLabel.style.display = 'block';
            categorizeComplete.style.display = 'none';
        }

        async function assignCategory(categoryId) {
            const spending = uncategorizedSpendings[currentSpendingIndex];
            
            try {
                const res = await fetch('/api/spendings/update-category', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        spendingId: spending.id,
                        categoryId: categoryId
                    })
                });

                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to update category:', data.error);
                    return;
                }

                // Move to next transaction
                currentSpendingIndex++;
                displayNextTransaction();
            } catch (err) {
                console.error('assignCategory error', err);
            }
        }

        // Store categorize load functions so they can be called when switching tabs
        categorizeLoadFunctions = () => {
            loadUncategorizedSpendings();
            loadCategories();
        };

        // Load categorize data on initial page load if categorize tab is active (unlikely but safe)
        const categorizeTabContent = document.querySelector('.tab-content[data-tab="1"]');
        if (categorizeTabContent && categorizeTabContent.classList.contains('active')) {
            categorizeLoadFunctions();
        }

        // Currency Selection functionality
        const currencyRow = document.querySelector('.currency-row');
        const currencySelectionPage = document.getElementById('currency-selection-page');
        const currencyBackButton = document.getElementById('currency-back-button');
        const currencyList = document.getElementById('currency-list');
        const settingsContent = document.querySelector('.settings-container');
        const currencyValueSpan = document.querySelector('.settings-row-value');
        let currencies = [];
        let currentCurrencyId = null;

        loadCurrentCurrency = async function() {
            try {
                const res = await fetch('/api/currencies/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });

                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to load current currency:', data.error);
                    return false;
                }

                currentCurrencyId = data.currentCurrencyId;
                if (currentCurrencyId) {
                    const currentCurrency = data.currencies?.find(c => c.id === currentCurrencyId);
                    if (currentCurrency) {
                        const previousCurrency = currentCurrencyCode;
                        currentCurrencyCode = currentCurrency.code;
                        if (currencyValueSpan) {
                            currencyValueSpan.textContent = currentCurrency.code;
                        }
                        // Reload spendings data if currency changed and we're on spendings tab
                        const activeTab = document.querySelector('.tab-content.active');
                        if (previousCurrency !== currentCurrency.code && spendingsLoadData && activeTab && activeTab.getAttribute('data-tab') === '0') {
                            spendingsLoadData();
                        }
                        return true;
                    }
                }
                return false;
            } catch (err) {
                console.error('loadCurrentCurrency error', err);
                return false;
            }
        };

        // Initialize app: load currency first, then data
        async function initializeApp() {
            showSkeletons();
            
            // Load currency first
            try {
                const currencyLoaded = await loadCurrentCurrency();
                if (currencyLoaded) {
                    console.log('Currency loaded:', currentCurrencyCode);
                } else {
                    console.warn('Currency loading returned false, using default USD');
                }
            } catch (err) {
                console.error('Failed to load currency on init:', err);
                // Continue with USD default
            }
            
            // Then load data with correct currency
            loadData(false);
        }
        
        initializeApp();

        async function loadCurrencies() {
            try {
                const res = await fetch('/api/currencies/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });

                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to load currencies:', data.error);
                    return;
                }

                currencies = data.currencies || [];
                currentCurrencyId = data.currentCurrencyId;
                renderCurrencyList();
            } catch (err) {
                console.error('loadCurrencies error', err);
            }
        }

        function renderCurrencyList() {
            currencyList.innerHTML = '';
            currencies.forEach(currency => {
                const isSelected = currency.id === currentCurrencyId;
                const item = document.createElement('div');
                item.className = 'currency-item';
                item.setAttribute('data-currency-id', currency.id);
                
                item.innerHTML = `
                    <div class="currency-item-content">
                        <div class="currency-item-left">
                            <span class="currency-code">${currency.code}</span>
                            <span class="currency-name">${currency.name}</span>
                        </div>
                        ${isSelected ? `
                            <svg class="checkmark-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z" fill="currentColor"/>
                            </svg>
                        ` : ''}
                    </div>
                `;
                
                item.addEventListener('click', () => selectCurrency(currency.id));
                currencyList.appendChild(item);
            });
        }

        function openCurrencyPage() {
            settingsContent.style.display = 'none';
            currencySelectionPage.style.display = 'block';
            loadCurrencies();
            
            // Haptic feedback
            if (tgWebApp && tgWebApp.HapticFeedback) {
                try {
                    tgWebApp.HapticFeedback.impactOccurred('light');
                } catch (e) {
                    if (tgWebApp.impactOccurred) {
                        tgWebApp.impactOccurred('light');
                    }
                }
            }
        }

        function closeCurrencyPage() {
            currencySelectionPage.style.display = 'none';
            settingsContent.style.display = 'block';
            
            // Haptic feedback
            if (tgWebApp && tgWebApp.HapticFeedback) {
                try {
                    tgWebApp.HapticFeedback.impactOccurred('light');
                } catch (e) {
                    if (tgWebApp.impactOccurred) {
                        tgWebApp.impactOccurred('light');
                    }
                }
            }
        }

        async function selectCurrency(currencyId) {
            try {
                const res = await fetch('/api/user/update-currency', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        currencyId: currencyId
                    })
                });

                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to update currency:', data.error);
                    alert('Failed to update currency: ' + (data.error || 'Unknown error'));
                    return;
                }

                // Update current currency
                currentCurrencyId = currencyId;
                const selectedCurrency = currencies.find(c => c.id === currencyId);
                
                if (selectedCurrency) {
                    // Update global currency code
                    currentCurrencyCode = selectedCurrency.code;
                    
                    // Update the currency value in settings
                    if (currencyValueSpan) {
                        currencyValueSpan.textContent = selectedCurrency.code;
                    }
                    
                    // Reload spendings data to update currency display
                    if (spendingsLoadData) {
                        spendingsLoadData();
                    }
                }

                // Update currency list
                renderCurrencyList();

                // Haptic feedback
                if (tgWebApp && tgWebApp.HapticFeedback) {
                    try {
                        tgWebApp.HapticFeedback.notificationOccurred('success');
                    } catch (e) {
                        if (tgWebApp.notificationOccurred) {
                            tgWebApp.notificationOccurred('success');
                        }
                    }
                }

                // Close the currency page after a short delay
                setTimeout(() => {
                    closeCurrencyPage();
                }, 300);
            } catch (err) {
                console.error('selectCurrency error', err);
                alert('Error updating currency');
            }
        }

        if (currencyRow) {
            currencyRow.addEventListener('click', openCurrencyPage);
        }

        if (currencyBackButton) {
            currencyBackButton.addEventListener('click', closeCurrencyPage);
        }

        // Currency is already loaded in initializeApp() above
    }
</script>


<style>
    * {
        box-sizing: border-box;
    }

    body {
        font-family: 'Nunito', sans-serif;
        background: #ffffff;
        color: #000000;
        margin: 0;
        padding: 0;
        padding-bottom: 80px; /* Space for tab bar */
    }

    #app {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        max-width: 600px;
        margin: 0 auto;
        position: relative;
    }

    #content {
        flex: 1;
        padding: 20px;
        padding-bottom: 100px;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .tab-placeholder {
        text-align: center;
        padding: 60px 20px;
        color: #999999;
    }

    .tab-placeholder p {
        font-size: 16px;
    }

    #header {
        margin-bottom: 32px;
        text-align: center;
        padding-top: 8vh;
        padding-bottom: 8vh;
    }

    #header-top {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 32px;
    }

    #net-total-label {
        font-size: 16px;
        font-weight: 600;
        color: #000000;
    }

    #period-dropdown-container {
        position: relative;
    }

    #month-pill.clickable-pill {
        font-size: 16px;
        font-weight: 600;
        color: #000000;
        background: #ffffff;
        border: 1px solid #DADADA;
        padding: 4px 10px;
        border-radius: 12px;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
    }

    #month-pill.clickable-pill:active {
        background-color: #e8e8e8;
    }

    .period-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        min-width: 140px;
        z-index: 100;
        overflow: hidden;
    }

    .period-option {
        padding: 12px 16px;
        font-size: 14px;
        color: #000000;
        cursor: pointer;
        transition: background-color 0.2s;
        user-select: none;
    }

    .period-option:hover {
        background-color: #f5f5f5;
    }

    .period-option.active {
        background-color: #e8e8e8;
        font-weight: 600;
    }

    .period-option:not(:last-child) {
        border-bottom: 1px solid #f0f0f0;
    }

    #total {
        font-size: 42px;
        font-weight: 700;
        line-height: 1.2;
        text-align: center;
    }

    #total .currency-label {
        color: #A6A6A6;
        font-weight: 600;
        font-size: 24px;
    }

    #total .amount-value {
        color: #000000;
        font-weight: 600;
        font-size: 50px;
    }

    .total-hidden {
        opacity: 0;
        transform: translateY(8px);
    }

    .total-reveal {
        animation: totalReveal 0.4s ease-out forwards;
    }

    @keyframes totalReveal {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .date-group {
        margin-bottom: 32px;
    }

    .date-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .date-label {
        font-size: 16px;
        color: #A6A6A6;
        font-weight: 700;
    }

    .daily-subtotal {
        font-size: 16px;
        color: #A6A6A6;
        font-weight: 700;
    }

    .date-divider {
        height: 1px;
        background: #e0e0e0;
        margin-bottom: 12px;
    }

    .transaction {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }

    .transaction-hidden {
        opacity: 0;
        transform: translateY(8px);
    }

    .transaction-reveal {
        animation: transactionReveal 0.4s ease-out forwards;
    }

    @keyframes transactionReveal {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .icon {
        width: 44px;
        height: 44px;
        background: purple;
        border-radius: 12px;
        margin-right: 14px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .icon-emoji {
        font-size: 22px;
        line-height: 1;
    }

    .info {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        overflow: hidden;
    }

    .name {
        font-size: 18px;
        font-weight: 650;
        color: #000000;
        margin-bottom: 0px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .time {
        font-size: 16px;
        color: #A6A6A6;
        font-weight: 600;
    }

    .amount {
        font-weight: 650;
        font-size: 20px;
        color: #000000;
        white-space: nowrap;
        margin-left: 24px;
    }

    .empty-state {
        text-align: center;
        color: #999999;
        font-size: 14px;
        padding: 40px 20px;
    }

    #tab-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #ffffff;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 16px 20px 24px 20px;
        padding-bottom: max(24px, calc(env(safe-area-inset-bottom) + 24px));
        z-index: 1000;
        max-width: 600px;
        margin: 0 auto;
    }

    .tab-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        padding: 8px 4px;
        cursor: pointer;
        transition: color 0.2s;
        color: #DADADA;
    }

    .tab-item.active {
        color: #1F1F1F;
    }

    .tab-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .tab-icon path {
        fill: currentColor;
    }

    .tab-label {
        display: none;
    }

    /* Categorize Tab Styles */
    #categorize-container {
        display: flex;
        flex-direction: column;
        min-height: 60vh;
    }

    .categorize-transaction {
        margin-bottom: 40px;
    }

    .categorize-transaction-item {
        display: flex;
        align-items: center;
        background: var(--tg-theme-secondary-bg-color, #f5f5f5);
        padding: 16px;
        border-radius: 14px;
    }

    #categorize-categories {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    #categorize-label {
        font-size: 18px;
        font-weight: 600;
        color: #000000;
        margin-bottom: 16px;
        text-align: center;
    }

    .categorize-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
        align-items: flex-start;
    }

    .category-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 16px 20px;
        border-radius: 14px;
        border: none;
        cursor: pointer;
        min-width: 100px;
        transition: transform 0.1s, opacity 0.1s;
    }

    .category-button:active {
        transform: scale(0.95);
        opacity: 0.8;
    }

    .category-emoji {
        font-size: 32px;
        margin-bottom: 8px;
    }

    .category-name {
        font-size: 14px;
        font-weight: 600;
        color: #000000;
        text-transform: capitalize;
    }

    .categorize-complete {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        text-align: center;
        padding: 60px 20px;
    }

    .categorize-complete h2 {
        font-size: 24px;
        font-weight: 600;
        color: #000000;
    }

    /* Edit Transaction Popup Styles */
    .edit-transaction-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 20px;
    }

    .edit-transaction-popup {
        background: #ffffff;
        border-radius: 20px;
        width: 100%;
        max-width: 400px;
        padding: 24px;
        position: relative;
    }

    .close-edit-button {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        font-size: 28px;
        color: #999999;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s, color 0.2s;
        line-height: 1;
        padding: 0;
    }

    .close-edit-button:hover {
        background-color: #f5f5f5;
        color: #000000;
    }

    .close-edit-button:active {
        background-color: #e8e8e8;
    }

    #edit-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 24px;
        padding-top: 8px;
    }

    .edit-input {
        width: 100%;
        padding: 16px;
        font-size: 18px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        background: #ffffff;
        color: #000000;
        text-align: center;
        font-family: 'Nunito', sans-serif;
    }

    .edit-input:focus {
        outline: none;
        border-color: #42A5F5;
    }

    .amount-input {
        font-size: 32px;
        font-weight: 600;
    }

    .name-input {
        font-size: 18px;
    }

    #edit-buttons {
        width: 100%;
        display: flex;
        gap: 12px;
        margin-top: 8px;
    }

    .edit-button {
        flex: 1;
        padding: 16px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.1s, opacity 0.1s;
        font-family: 'Nunito', sans-serif;
    }

    .edit-button:active {
        transform: scale(0.98);
        opacity: 0.9;
    }

    .save-button {
        background-color: #42A5F5;
        color: #ffffff;
    }

    .save-button:hover {
        background-color: #2196F3;
    }

    .delete-button {
        background-color: #E57373;
        color: #ffffff;
    }

    .delete-button:hover {
        background-color: #EF5350;
    }

    /* Settings Tab Styles */

    .settings-header {
        font-size: 32px;
        font-weight: 700;
        color: #000000;
        margin: 0;
        margin-bottom: 32px;
        text-align: left;
    }

    .settings-section {
        margin-bottom: 32px;
    }

    .settings-subheader {
        font-size: 14px;
        font-weight: 400;
        color: #A6A6A6;
        margin-bottom: 8px;
        text-align: left;
    }

    .settings-divider {
        height: 1px;
        background-color: #E0E0E0;
        margin-bottom: 16px;
    }

    .settings-row {
        display: flex;
        align-items: center;
        padding: 16px;
        background-color: #F5F5F5;
        border-radius: 12px;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        gap: 12px;
    }

    .settings-row:active {
        background-color: #E8E8E8;
        transform: scale(0.98);
    }

    .currency-icon-wrapper {
        width: 40px;
        height: 40px;
        background-color: #A5D6A7;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .currency-icon {
        width: 24px;
        height: 24px;
        color: #ffffff;
    }

    .settings-row-label {
        flex: 1;
        font-size: 16px;
        font-weight: 400;
        color: #000000;
        text-align: left;
    }

    .settings-row-right {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .settings-row-value {
        font-size: 14px;
        font-weight: 400;
        color: #A4A4A8;
    }

    .chevron-icon {
        width: 24px;
        height: 24px;
        color: #A4A4A8;
        flex-shrink: 0;
    }

    /* Currency Selection Page Styles */
    .currency-selection-page {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ffffff;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        max-width: 600px;
        margin: 0 auto;
        padding-bottom: 80px;
    }

    .currency-page-header {
        background-color: #F5F5F5;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
    }

    .currency-back-button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #E0E0E0;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        flex-shrink: 0;
        padding: 0;
    }

    .currency-back-button:active {
        background-color: #D0D0D0;
        transform: scale(0.95);
    }

    .back-chevron-icon {
        width: 24px;
        height: 24px;
        color: #000000;
    }

    .currency-page-title {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        font-size: 32px;
        font-weight: 700;
        color: #000000;
        margin: 0;
    }

    .currency-list {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .currency-item {
        padding: 16px 0;
        cursor: pointer;
        transition: background-color 0.2s;
        border-bottom: 1px solid #F0F0F0;
    }

    .currency-item:active {
        background-color: #F5F5F5;
    }

    .currency-item-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .currency-item-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .currency-code {
        font-size: 14px;
        font-weight: 400;
        color: #A4A4A8;
    }

    .currency-name {
        font-size: 16px;
        font-weight: 400;
        color: #000000;
    }

    .checkmark-icon {
        width: 24px;
        height: 24px;
        color: #000000;
        flex-shrink: 0;
    }

    /* Skeleton Loader Styles */
    .skeleton-box {
        display: inline-block;
        background: linear-gradient(90deg, #E0E0E0 25%, #F5F5F5 50%, #E0E0E0 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
        border-radius: 4px;
    }

    @keyframes skeleton-loading {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }

    .skeleton-total {
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 8px;
    }

    .skeleton-currency {
        width: 60px;
        height: 32px;
    }

    .skeleton-amount {
        width: 180px;
        height: 42px;
    }

    .skeleton-transactions {
        display: flex;
        flex-direction: column;
    }

    .skeleton-transaction-group {
        margin-bottom: 32px;
    }

    .skeleton-date-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .skeleton-date-label {
        width: 120px;
        height: 16px;
    }

    .skeleton-date-subtotal {
        width: 100px;
        height: 16px;
    }

    .skeleton-date-divider {
        height: 1px;
        background: #e0e0e0;
        margin-bottom: 12px;
    }

    .skeleton-transaction {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }

    .skeleton-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        margin-right: 14px;
        flex-shrink: 0;
        background: linear-gradient(90deg, #E0E0E0 25%, #F5F5F5 50%, #E0E0E0 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
    }

    .skeleton-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
    }

    .skeleton-name {
        width: 60%;
        height: 18px;
    }

    .skeleton-time {
        width: 40%;
        height: 16px;
    }

    .skeleton-amount-right {
        width: 100px;
        height: 20px;
        margin-left: 24px;
    }
</style>
</body>
</html>
